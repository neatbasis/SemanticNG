#!/usr/bin/env bash
set -euo pipefail

repo_root=$(git rev-parse --show-toplevel)
cd "$repo_root"

changed_files=$(git diff --cached --name-only)

needs_replay_checks=false
if echo "$changed_files" | rg -q '^(docs/dod_manifest.json|docs/system_contract_map.md|ROADMAP.md|demos/|tests/test_scenario_convergence_reporting.py|src/state_renormalization/)'; then
  needs_replay_checks=true
fi

echo "[pre-commit] Running baseline governance guard tests..."
pytest tests/test_validate_milestone_docs.py tests/test_governance_pr_evidence_validator.py -q

if [ "$needs_replay_checks" = true ]; then
  echo "[pre-commit] Replay/convergence files staged; running replay analytics evidence command set..."
  pytest tests/test_predictions_contracts_and_gates.py tests/test_persistence_jsonl.py -q
  pytest tests/test_replay_projection_analytics.py tests/test_replay_projection_determinism.py tests/test_replay_projection_restart_contracts.py tests/test_prediction_outcome_binding.py tests/replay_projection_analytics/test_append_only_replay.py -q
  pytest tests/test_hitl_protocol.py tests/test_engine_projection_mission_loop.py tests/test_contracts_halt_record.py tests/test_demo_runner.py -q
  pytest tests/test_scenario_convergence_reporting.py -q
fi

if echo "$changed_files" | rg -q '^(docs/dod_manifest.json|docs/system_contract_map.md|ROADMAP.md|.github/pull_request_template.md)'; then
  echo "[pre-commit] Running milestone docs validator with synthetic PR-body adjacency evidence..."
  base_sha=$(git rev-parse HEAD)
  head_sha=$(git rev-parse HEAD)

  event_path=$(mktemp)
  python .github/scripts/render_transition_evidence.py --base "$base_sha" --head "$head_sha" --as-pr-body-json > "$event_path"
  GITHUB_EVENT_NAME=pull_request GITHUB_EVENT_PATH="$event_path" BASE_SHA="$base_sha" HEAD_SHA="$head_sha" python .github/scripts/validate_milestone_docs.py
  rm -f "$event_path"
fi
