name: State Renormalization Milestone Gate

on:
  pull_request:
    paths:
      - 'src/state_renormalization/**'
      - 'docs/dod_manifest.json'
      - 'docs/system_contract_map.md'
      - 'ROADMAP.md'
      - '.github/pull_request_template.md'
      - '.github/scripts/validate_milestone_docs.py'
      - '.github/scripts/capability_parity_report.py'
      - '.github/scripts/render_transition_evidence.py'
      - '.github/workflows/state-renorm-milestone-gate.yml'
  pull_request_target:
    paths:
      - 'src/state_renormalization/**'
      - 'docs/dod_manifest.json'
      - 'docs/system_contract_map.md'
      - 'ROADMAP.md'
      - '.github/pull_request_template.md'
      - '.github/scripts/validate_milestone_docs.py'
      - '.github/scripts/capability_parity_report.py'
      - '.github/scripts/render_transition_evidence.py'
      - '.github/workflows/state-renorm-milestone-gate.yml'
  merge_group:
    paths:
      - 'src/state_renormalization/**'
      - 'docs/dod_manifest.json'
      - 'docs/system_contract_map.md'
      - 'ROADMAP.md'
      - '.github/pull_request_template.md'
      - '.github/scripts/validate_milestone_docs.py'
      - '.github/scripts/capability_parity_report.py'
      - '.github/scripts/render_transition_evidence.py'
      - '.github/workflows/state-renorm-milestone-gate.yml'

jobs:
  milestone-pytest:
    runs-on: self-hosted
    permissions:
      contents: read
      issues: write
    steps:
      - name: Check out
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[test]"

      - name: Compute diff SHAs
        id: shas
        env:
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          MERGE_GROUP_BASE_SHA: ${{ github.event.merge_group.base_sha }}
          MERGE_GROUP_HEAD_SHA: ${{ github.event.merge_group.head_sha }}
        run: |
          set -euo pipefail
          base_sha="${PR_BASE_SHA:-${MERGE_GROUP_BASE_SHA:-}}"
          head_sha="${PR_HEAD_SHA:-${MERGE_GROUP_HEAD_SHA:-}}"

          if [[ -z "$base_sha" || -z "$head_sha" ]]; then
            echo "Unable to determine BASE_SHA/HEAD_SHA from event context."
            exit 1
          fi

          echo "BASE_SHA=$base_sha" >> "$GITHUB_ENV"
          echo "HEAD_SHA=$head_sha" >> "$GITHUB_ENV"
          echo "base_sha=$base_sha" >> "$GITHUB_OUTPUT"
          echo "head_sha=$head_sha" >> "$GITHUB_OUTPUT"

      - name: Verify PR template AUTOGEN section is current
        run: |
          python .github/scripts/render_transition_evidence.py --check-pr-template-autogen

      - name: Run AUTOGEN parity pytest
        run: |
          pytest tests/test_render_transition_evidence.py tests/test_pr_template_autogen_governance.py

      - name: Render transition evidence block
        id: render_transition_evidence
        if: ${{ always() }}
        run: |
          set -euo pipefail
          mkdir -p artifacts
          python .github/scripts/render_transition_evidence.py --base "$BASE_SHA" --head "$HEAD_SHA" \
            | tee artifacts/transition_evidence.txt

          {
            echo "## Milestone transition evidence"
            cat artifacts/transition_evidence.txt
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload transition evidence artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: transition_evidence.txt
          path: artifacts/transition_evidence.txt
          if-no-files-found: error

      - name: Validate milestone documentation governance
        id: validate_milestone
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          set -euo pipefail
          echo "VALIDATOR_MISSING_EVIDENCE=false" >> "$GITHUB_ENV"

          set +e
          python .github/scripts/validate_milestone_docs.py 2>&1 | tee artifacts/validate_milestone_docs.log
          validator_status=${PIPESTATUS[0]}
          set -e

          if [[ $validator_status -ne 0 ]]; then
            echo
            echo "Action required: paste the exact transition evidence block from artifacts/transition_evidence.txt into the PR body."
            cat artifacts/transition_evidence.txt

            if grep -Fq "MILESTONE_VALIDATION_ERROR=MISSING_PR_EVIDENCE" artifacts/validate_milestone_docs.log; then
              echo "VALIDATOR_MISSING_EVIDENCE=true" >> "$GITHUB_ENV"

              echo
              echo "Milestone validation failed: PR description is missing transitioned-capability evidence."
              echo "See transition evidence block above."
            else
              echo
              echo "Milestone validation failed. See artifacts/validate_milestone_docs.log for details."
            fi
            exit "$validator_status"
          fi

      - name: Comment transition evidence block on PR when validation fails
        if: ${{ failure() && github.event_name == 'pull_request' && env.VALIDATOR_MISSING_EVIDENCE == 'true' }}
        continue-on-error: true
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          {
            echo "### Transition Evidence Block"
            echo
            echo "Validation failed due to missing transition evidence."
            echo "Copy this exact block into the PR description:"
            echo
            cat artifacts/transition_evidence.txt
          } > artifacts/transition_evidence_comment.md

      - name: Post transition evidence comment using GitHub API
        if: ${{ failure() && github.event_name == 'pull_request' && env.VALIDATOR_MISSING_EVIDENCE == 'true' }}
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('artifacts/transition_evidence_comment.md', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number(process.env.PR_NUMBER),
              body,
            });
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Generate capability parity report
        run: python .github/scripts/capability_parity_report.py

      - name: Run deterministic capability parity pytest coverage
        run: pytest tests/test_capability_parity_report.py

      - name: Upload capability parity report artifact
        uses: actions/upload-artifact@v4
        with:
          name: capability-parity-report
          path: artifacts/capability_parity_report.txt
          if-no-files-found: error

      - name: Run milestone pytest commands for relevant changes
        run: |
          python - <<'PY'
          import json
          import os
          import subprocess
          import sys
          from pathlib import Path

          def _matches_code_path(changed_file: str, code_path: str) -> bool:
              normalized = code_path.rstrip("/")
              return changed_file == normalized or changed_file.startswith(f"{normalized}/")

          manifest_path = Path("docs/dod_manifest.json")
          manifest = json.loads(manifest_path.read_text(encoding="utf-8"))
          capabilities = manifest.get("capabilities", [])

          base_sha = os.environ.get("BASE_SHA")
          head_sha = os.environ.get("HEAD_SHA")
          if not base_sha or not head_sha:
              print("Missing base/head SHA context; failing gate.")
              sys.exit(1)

          changed_files_cmd = ["git", "diff", "--name-only", base_sha, head_sha]
          changed_files_out = subprocess.check_output(changed_files_cmd, text=True)
          changed_files = [line.strip() for line in changed_files_out.splitlines() if line.strip()]
          touches_state_renorm = any(path.startswith("src/state_renormalization/") for path in changed_files)

          print("Changed files:")
          for path in changed_files:
              print(f"  - {path}")

          commands = []

          manifest_changed = "docs/dod_manifest.json" in changed_files
          for capability in capabilities:
              if capability.get("status") != "in_progress":
                  continue

              capability_paths = capability.get("code_paths", [])
              capability_changed = touches_state_renorm or manifest_changed or any(
                  _matches_code_path(changed, code_path)
                  for changed in changed_files
                  for code_path in capability_paths
              )

              if capability_changed:
                  commands.extend(capability.get("pytest_commands", []))

          base_manifest_raw = subprocess.check_output(
              ["git", "show", f"{base_sha}:docs/dod_manifest.json"],
              text=True,
          )
          base_manifest = json.loads(base_manifest_raw)
          base_by_id = {cap["id"]: cap for cap in base_manifest.get("capabilities", [])}
          head_by_id = {cap["id"]: cap for cap in capabilities}

          transitioned_to_done = []
          for capability_id, head_capability in head_by_id.items():
              base_capability = base_by_id.get(capability_id)
              if not base_capability:
                  continue
              if base_capability.get("status") == "in_progress" and head_capability.get("status") == "done":
                  transitioned_to_done.append(head_capability)

          if transitioned_to_done:
              docs_updated = any(
                  path == "README.md" or (path.startswith("docs/") and path != "docs/dod_manifest.json")
                  for path in changed_files
              )
              if not docs_updated:
                  print("Detected in_progress -> done transition without non-manifest documentation updates.")
                  print("Update README.md and/or docs/*.md alongside status transitions.")
                  sys.exit(1)

              print("Capabilities transitioned in_progress -> done:")
              for capability in transitioned_to_done:
                  print(f"  - {capability['id']}")
                  commands.extend(capability.get("pytest_commands", []))

          deduped_commands = []
          seen = set()
          for command in commands:
              if command in seen:
                  continue
              seen.add(command)
              deduped_commands.append(command)

          if not deduped_commands:
              print("No relevant milestone pytest commands for this change set.")
              sys.exit(0)

          for command in deduped_commands:
              print(f"\n>>> Running: {command}")
              completed = subprocess.run(command, shell=True)
              if completed.returncode != 0:
                  sys.exit(completed.returncode)

          print("\nAll relevant milestone pytest commands passed.")
          PY
