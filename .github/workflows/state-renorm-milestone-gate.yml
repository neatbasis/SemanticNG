name: State Renormalization Milestone Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review]
    paths:
      - 'src/state_renormalization/**'
      - 'docs/dod_manifest.json'
      - 'docs/doc_freshness_slo.json'
      - 'docs/release_checklist.md'
      - 'docs/documentation_change_control.md'
      - 'docs/sprint_handoffs/**'
      - 'docs/system_contract_map.md'
      - 'ROADMAP.md'
      - '.github/pull_request_template.md'
      - '.github/scripts/validate_milestone_docs.py'
      - '.github/scripts/validate_sprint_handoff.py'
      - '.github/scripts/validate_doc_freshness_slo.py'
      - '.github/scripts/capability_parity_report.py'
      - '.github/scripts/render_transition_evidence.py'
      - '.github/workflows/state-renorm-milestone-gate.yml'
      - '.github/workflows/quality-guardrails.yml'
      - '.github/actions/python-test-setup/action.yml'
  pull_request_target:
    types: [opened, synchronize, reopened, edited, ready_for_review]
    paths:
      - 'src/state_renormalization/**'
      - 'docs/dod_manifest.json'
      - 'docs/doc_freshness_slo.json'
      - 'docs/release_checklist.md'
      - 'docs/documentation_change_control.md'
      - 'docs/sprint_handoffs/**'
      - 'docs/system_contract_map.md'
      - 'ROADMAP.md'
      - '.github/pull_request_template.md'
      - '.github/scripts/validate_milestone_docs.py'
      - '.github/scripts/validate_sprint_handoff.py'
      - '.github/scripts/validate_doc_freshness_slo.py'
      - '.github/scripts/capability_parity_report.py'
      - '.github/scripts/render_transition_evidence.py'
      - '.github/workflows/state-renorm-milestone-gate.yml'
      - '.github/workflows/quality-guardrails.yml'
      - '.github/actions/python-test-setup/action.yml'
  merge_group:
    paths:
      - 'src/state_renormalization/**'
      - 'docs/dod_manifest.json'
      - 'docs/doc_freshness_slo.json'
      - 'docs/release_checklist.md'
      - 'docs/documentation_change_control.md'
      - 'docs/sprint_handoffs/**'
      - 'docs/system_contract_map.md'
      - 'ROADMAP.md'
      - '.github/pull_request_template.md'
      - '.github/scripts/validate_milestone_docs.py'
      - '.github/scripts/validate_sprint_handoff.py'
      - '.github/scripts/validate_doc_freshness_slo.py'
      - '.github/scripts/capability_parity_report.py'
      - '.github/scripts/render_transition_evidence.py'
      - '.github/workflows/state-renorm-milestone-gate.yml'
      - '.github/workflows/quality-guardrails.yml'
      - '.github/actions/python-test-setup/action.yml'

jobs:
  baseline-quality:
    runs-on: self-hosted
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Shared Python setup
        uses: ./.github/actions/python-test-setup

      - name: Verify Python support policy sync
        run: python .github/scripts/check_python_support_policy.py

      - name: Print environment provenance
        run: python .github/scripts/print_env_provenance.py

      - name: Run baseline lint/type checks
        run: make qa-hook-parity

      - name: Run baseline tests with coverage gate
        run: pytest --cov --cov-report=term-missing --cov-report=xml

  milestone-governance:
    runs-on: self-hosted
    needs: [baseline-quality]
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Shared Python setup
        uses: ./.github/actions/python-test-setup

      - name: Compute diff SHAs
        id: shas
        env:
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          MERGE_GROUP_BASE_SHA: ${{ github.event.merge_group.base_sha }}
          MERGE_GROUP_HEAD_SHA: ${{ github.event.merge_group.head_sha }}
        run: |
          set -euo pipefail
          base_sha="${PR_BASE_SHA:-${MERGE_GROUP_BASE_SHA:-}}"
          head_sha="${PR_HEAD_SHA:-${MERGE_GROUP_HEAD_SHA:-}}"

          if [[ -z "$base_sha" || -z "$head_sha" ]]; then
            echo "Unable to determine BASE_SHA/HEAD_SHA from event context."
            exit 1
          fi

          echo "BASE_SHA=$base_sha" >> "$GITHUB_ENV"
          echo "HEAD_SHA=$head_sha" >> "$GITHUB_ENV"
          echo "base_sha=$base_sha" >> "$GITHUB_OUTPUT"
          echo "head_sha=$head_sha" >> "$GITHUB_OUTPUT"

      - name: Verify PR template AUTOGEN section is current
        run: |
          python .github/scripts/render_transition_evidence.py --check-pr-template-autogen

      - name: Run milestone governance targeted pytest suite
        run: |
          pytest tests/test_render_transition_evidence.py tests/test_pr_template_autogen_governance.py tests/test_sprint_handoff_validation.py

      - name: Render transition evidence block
        id: render_transition_evidence
        if: ${{ always() }}
        run: |
          set -euo pipefail
          mkdir -p artifacts
          python .github/scripts/render_transition_evidence.py --base "$BASE_SHA" --head "$HEAD_SHA" \
            | tee artifacts/transition_evidence.txt

          {
            echo "## Milestone transition evidence"
            cat artifacts/transition_evidence.txt
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload transition evidence artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: transition_evidence.txt
          path: artifacts/transition_evidence.txt
          if-no-files-found: error

      - name: Validate milestone manifest/doc parity
        id: validate_milestone
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          set -euo pipefail
          set +e
          python .github/scripts/validate_milestone_docs.py 2>&1 | tee artifacts/validate_milestone_docs.log
          validator_status=${PIPESTATUS[0]}
          set -e

          if [[ $validator_status -ne 0 ]]; then
            echo
            echo "Milestone validation failed. See artifacts/validate_milestone_docs.log for details."
            exit "$validator_status"
          fi

      - name: Validate sprint handoff artifacts
        run: |
          python .github/scripts/validate_sprint_handoff.py

      - name: Validate documentation freshness SLO
        run: |
          python .github/scripts/validate_doc_freshness_slo.py --config docs/doc_freshness_slo.json

      - name: Select and run milestone pytest commands for relevant changes
        run: |
          set -euo pipefail
          python .github/scripts/select_milestone_test_commands.py \
            --base "$BASE_SHA" \
            --head "$HEAD_SHA" \
            --run

      - name: Publish milestone command selection summary
        if: ${{ always() }}
        run: |
          if [[ -f artifacts/milestone_test_selection_summary.md ]]; then
            cat artifacts/milestone_test_selection_summary.md >> "$GITHUB_STEP_SUMMARY"
          fi
