# Architecture Map (scan-first)

| Concept | Primary code files | Primary tests | BDD scenarios (if any) |
|---|---|---|---|
| Ambiguity resolution (detect unresolved intent/entity gaps and generate clarifying asks) | `src/state_renormalization/adapters/schema_selector.py`<br>`src/state_renormalization/contracts.py` | `tests/test_schema_selector.py`<br>`tests/test_schema_bubbling_option_a.py`<br>`tests/test_capture_outcome_states.py` | _None currently tied to this path_ |
| Pending-obligation state (carry unresolved ambiguity into belief state) | `src/state_renormalization/engine.py` (`apply_schema_bubbling`)<br>`src/state_renormalization/contracts.py` (`BeliefState`) | `tests/test_engine_pending_obligation.py`<br>`tests/test_engine_pending_obligation_minimal.py` | _None currently tied to this path_ |
| Invariant gating (P0/P1/H0 stop-or-continue checks) | `src/state_renormalization/invariants.py`<br>`src/state_renormalization/engine.py` (`evaluate_invariant_gates`) | `tests/test_predictions_contracts_and_gates.py` | _None currently tied to this path_ |
| Prediction persistence + projection (append-only prediction log and current view) | `src/state_renormalization/adapters/persistence.py`<br>`src/state_renormalization/engine.py` (`append_prediction_record`, `project_current`)<br>`src/state_renormalization/contracts.py` (`PredictionRecord`, `ProjectionState`) | `tests/test_persistence_jsonl.py`<br>`tests/test_predictions_contracts_and_gates.py` | _None currently tied to this path_ |
| Channel-agnostic contract surface (avoid HA/satellite-specific core field names) | `src/state_renormalization/contracts.py`<br>`src/state_renormalization/engine.py` | `tests/test_contracts_belief_state.py`<br>`tests/test_contracts_decision_effect_shape.py`<br>`tests/test_engine_calls_selector_with_generic_error.py` | _None currently tied to this path_ |
| Resource/ontology/indexing path (ingest → validate → materialize → index) | `src/features/steps/index_steps.py`<br>`src/features/steps/ontology_steps.py`<br>`src/features/steps/steps.py` | (BDD-driven; no dedicated pytest module in `tests/`) | `src/features/index/evidence_grounded_adaptive_indexing.feature` (both scenarios)<br>`src/features/core/resource.feature` (Create a minimal Resource)<br>`src/features/ontology/ontology_contains_class.feature` (Ontology contains class) |
